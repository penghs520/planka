#!/bin/bash

# Git pre-commit hook
# åœ¨æäº¤å‰ç¡®ä¿ç±»å‹æ£€æŸ¥å’Œç¼–ç è§„èŒƒç¬¦åˆè¦æ±‚

set -e

echo "ğŸ” Running pre-commit checks..."

# è·å–é¡¹ç›®æ ¹ç›®å½•
ROOT_DIR="$(git rev-parse --show-toplevel)"

# æ£€æŸ¥æ˜¯å¦æœ‰å‰ç«¯æ–‡ä»¶å˜æ›´
FRONTEND_CHANGED=$(git diff --cached --name-only | grep -E "^kanban-ui/" || true)

# æ£€æŸ¥æ˜¯å¦æœ‰åç«¯æ–‡ä»¶å˜æ›´
BACKEND_CHANGED=$(git diff --cached --name-only | grep -E "\.java$" || true)

# å‰ç«¯æ£€æŸ¥
if [ -n "$FRONTEND_CHANGED" ]; then
    echo ""
    echo "ğŸ“¦ Frontend files changed, running TypeScript check..."
    cd "$ROOT_DIR/kanban-ui"

    # TypeScript ç±»å‹æ£€æŸ¥
    if ! npx vue-tsc --noEmit; then
        echo ""
        echo "âŒ TypeScript check failed!"
        echo "Please fix the type errors before committing."
        exit 1
    fi
    echo "âœ… TypeScript check passed"

    # ESLint æ£€æŸ¥
    echo "ğŸ” Running ESLint check..."
    if ! pnpm lint:check; then
        echo ""
        echo "âŒ ESLint check failed!"
        echo "Please fix the lint errors or run 'pnpm lint' to auto-fix."
        exit 1
    fi
    echo "âœ… ESLint check passed"

    # è¿è¡Œå•å…ƒæµ‹è¯•
    echo "ğŸ§ª Running frontend unit tests..."
    if ! pnpm test:run; then
        echo ""
        echo "âŒ Frontend unit tests failed!"
        echo "Please fix the failing tests before committing."
        exit 1
    fi
    echo "âœ… Frontend unit tests passed"

    # è¿è¡Œå‰ç«¯æ„å»º
    echo "ğŸ§ª Running frontend build..."
    if ! pnpm build; then
        echo ""
        echo "âŒ Frontend build failed!"
        echo "Please fix the failing build before committing."
        exit 1
    fi
    echo "âœ… Frontend build passed"

    cd "$ROOT_DIR"
fi

# åç«¯æ£€æŸ¥
if [ -n "$BACKEND_CHANGED" ]; then
    echo ""
    echo "â˜• Java files changed, detecting affected modules..."
    cd "$ROOT_DIR"

    # ä»å˜æ›´çš„æ–‡ä»¶è·¯å¾„ä¸­æå–å—å½±å“çš„æ¨¡å—
    AFFECTED_MODULES=""
    
    for file in $BACKEND_CHANGED; do
        # ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ¨¡å—è·¯å¾„
        # ä¾‹å¦‚: kanban-services/schema-service/src/main/java/... -> kanban-services/schema-service
        # æˆ–è€…: zgraph-driver/src/test/java/... -> zgraph-driver
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯å¤šå±‚æ¨¡å—ç»“æ„ (å¦‚ kanban-services/schema-service)
        if [[ "$file" =~ ^([^/]+/[^/]+)/src/ ]]; then
            module="${BASH_REMATCH[1]}"
        elif [[ "$file" =~ ^([^/]+)/src/ ]]; then
            module="${BASH_REMATCH[1]}"
        else
            continue
        fi
        
        # æ£€æŸ¥æ¨¡å—ç›®å½•æ˜¯å¦å­˜åœ¨ pom.xml
        if [ -f "$ROOT_DIR/$module/pom.xml" ]; then
            # é¿å…é‡å¤æ·»åŠ 
            if [[ ! "$AFFECTED_MODULES" =~ "$module" ]]; then
                if [ -z "$AFFECTED_MODULES" ]; then
                    AFFECTED_MODULES="$module"
                else
                    AFFECTED_MODULES="$AFFECTED_MODULES,$module"
                fi
            fi
        fi
    done
    
    if [ -z "$AFFECTED_MODULES" ]; then
        echo "No Maven modules detected in changes, skipping tests."
    else
        echo "ğŸ“‹ Affected modules: $AFFECTED_MODULES"
        echo "ğŸ§ª Running tests for affected modules..."
        
        # ä½¿ç”¨ -pl æŒ‡å®šæ¨¡å—ï¼Œ-am ç¡®ä¿ä¹Ÿæ„å»ºä¾èµ–æ¨¡å—
        if ! mvn test -pl "$AFFECTED_MODULES" -am -q; then
            echo ""
            echo "âŒ Maven test failed!"
            echo "Please fix the compile errors or failing tests before committing."
            exit 1
        fi
        echo "âœ… Maven test passed"
    fi
fi

echo ""
echo "âœ… All pre-commit checks passed!"
