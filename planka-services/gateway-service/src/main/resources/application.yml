server:
  port: 9000

spring:
  application:
    name: gateway-service

  # Nacos 服务注册配置
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:localhost:28848}
        namespace: ${NACOS_NAMESPACE:public}

    # Gateway 路由配置
    gateway:
      routes:
        # Schema 服务路由
        - id: schema-service
          uri: lb://schema-service
          predicates:
            - Path=/api/v1/schemas/**,/api/v1/conditions/**,/api/v1/outsourcing-config/**

        # User 服务路由
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/v1/auth/**,/api/v1/users/**,/api/v1/organizations/**,/api/v1/members/**,/api/v1/admin/**

        # Card 服务路由
        - id: card-service
          uri: lb://card-service
          predicates:
            - Path=/api/v1/cards/**,/api/v1/links/**,/api/v1/structure-options/**,/api/v1/biz-rules/execution-logs/**

        # View 服务路由
        - id: view-service
          uri: lb://view-service
          predicates:
            - Path=/api/v1/view-data/**

        # Extension 服务路由（操作历史、评论等扩展功能）
        - id: extension-service
          uri: lb://extension-service
          predicates:
            - Path=/api/v1/history/**,/api/v1/comments/**,/api/v1/suggestions/**

        # OSS 服务路由
        - id: oss-service
          uri: lb://oss-service
          predicates:
            - Path=/api/v1/files/**

        # Workload 服务路由
        - id: workload-service
          uri: lb://workload-service
          predicates:
            - Path=/api/v1/workload/**,/api/v1/attendance-validation/**

      # 全局跨域配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # HTTP 客户端配置
      httpclient:
        # 连接超时（毫秒）
        connect-timeout: 5000
        # 响应超时（毫秒）- AI 配置生成可能需要较长时间
        response-timeout: 120s
        # 连接池配置
        pool:
          # 连接池类型：ELASTIC（弹性）或 FIXED（固定）
          type: ELASTIC
          # 最大空闲时间，设置为比后端 Tomcat keep-alive-timeout (60s) 更短的值
          max-idle-time: 20s
          # 连接最大生命周期
          max-life-time: 60s
          # 获取连接超时
          acquire-timeout: 5000
          # 驱逐检查间隔（用于清理无效连接）
          eviction-interval: 5s
        # 启用 Wiretap 日志（调试连接问题时可设为 true，生产环境建议关闭以减少日志量）
        # 开启后会记录完整的 HTTP 请求/响应头和二进制数据流，配合 reactor.netty.http.client=DEBUG 使用
        wiretap: false
        # 压缩支持
        compression: true

      # 默认过滤器配置
      default-filters:
        # 失败时自动重试（处理 PrematureCloseException）
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE,GATEWAY_TIMEOUT
            methods: GET,POST,PUT,DELETE
            backoff:
              firstBackoff: 100ms
              maxBackoff: 500ms
              factor: 2
              basedOnPreviousValue: false
            exceptions:
              - reactor.netty.http.client.PrematureCloseException
              - java.io.IOException
              - java.net.ConnectException

# JWT 配置
jwt:
  secret: ${JWT_SECRET:planka-jwt-secret-key-must-be-at-least-256-bits-long-for-hs256}
  # 白名单路径（不需要认证）
  white-list:
    - /api/v1/auth/login
    - /api/v1/auth/activate
    - /api/v1/auth/refresh
    - /api/v1/files/*/content
    - /actuator/**
    - /api/v1/schemas/debug/**
    - /api/v1/cards/debug/**

# 日志配置
logging:
  level:
    dev.planka: DEBUG
    org.springframework.cloud.gateway: DEBUG
    # Reactor Netty HTTP 客户端日志，用于诊断连接问题
    reactor.netty.http.client: DEBUG
    # Reactor Netty 资源管理日志
    reactor.netty.resources: DEBUG
    # Spring Cloud LoadBalancer 日志
    org.springframework.cloud.loadbalancer: DEBUG

# Actuator 端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      enabled: true
