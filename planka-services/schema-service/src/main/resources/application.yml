server:
  port: 8100
  # Tomcat 连接管理配置
  tomcat:
    # 连接超时（毫秒）
    connection-timeout: 20000
    # Keep-Alive 超时（毫秒）
    keep-alive-timeout: 60000
    # 最大 Keep-Alive 请求数
    max-keep-alive-requests: 100
    # 最大连接数
    max-connections: 8192
    threads:
      # 最大工作线程数
      max: 200
      # 最小工作线程数
      min-spare: 10

spring:
  application:
    name: schema-service

  # Nacos 服务注册配置
  cloud:
    nacos:
      discovery:
        server-addr: localhost:18848
        namespace: public

  # 数据源配置
  datasource:
    url: jdbc:mysql://localhost:13306/kanban_schema?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
    # HikariCP 连接池配置
    hikari:
      # 最小空闲连接数
      minimum-idle: 2
      # 最大连接池大小
      maximum-pool-size: 10
      # 空闲连接超时时间（毫秒），超时后会被回收
      idle-timeout: 30000
      # 连接最大存活时间（毫秒），防止连接过旧
      max-lifetime: 1800000
      # 获取连接超时时间（毫秒）
      connection-timeout: 30000
      # 连接池名称，便于监控
      pool-name: SchemaServiceHikariCP
      # 连接泄漏检测阈值（毫秒），超过此时间未归还连接会记录日志
      leak-detection-threshold: 60000

  # Redis配置
  data:
    redis:
      host: localhost
      port: 16379
      database: 0
      timeout: 3000ms

  # Kafka配置
  kafka:
    bootstrap-servers: 127.0.0.1:19092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        # 连接空闲超时设置为5分钟（小于broker的connections.max.idle.ms默认10分钟）
        connections.max.idle.ms: 300000
        # 重连退避时间
        reconnect.backoff.ms: 1000
        reconnect.backoff.max.ms: 10000
        # 请求超时
        request.timeout.ms: 30000
        # 重试次数
        retries: 3
        retry.backoff.ms: 500
    consumer:
      group-id: schema-service
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        # Consumer 连接保活配置
        connections.max.idle.ms: 300000
        reconnect.backoff.ms: 1000
        reconnect.backoff.max.ms: 10000

# MyBatis Plus配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: input

# Schema服务配置
schema:
  cache:
    # 缓存过期时间（秒）
    schema-ttl: 1800
    index-ttl: 600
    reference-ttl: 1800
  # 缓存预热
  preload:
    enabled: true
    types:
      - CARD_TYPE
      - VALUE_STREAM
      - CUSTOMIZED_FIELD

# OpenFeign 配置
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 10000
        loggerLevel: FULL

# 日志配置
logging:
  level:
    dev.planka: DEBUG
    org.springframework.kafka: INFO
